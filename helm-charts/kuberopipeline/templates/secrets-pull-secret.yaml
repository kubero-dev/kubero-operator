{{- $name := .Values.name -}}
{{- $deploymentstrategy := .Values.deploymentstrategy -}}
{{- $createSecret := .Values.registry.createSecret | default false -}}
{{- $dockerconfigjson := .Values.registry.dockerconfigjson | b64enc -}}
{{- $registryUsername := .Values.registry.username | b64enc -}}
{{- $registryPassword := .Values.registry.password | b64enc -}}
---
{{- range .Values.phases }}
{{- if .enabled }}
{{- if and (eq $deploymentstrategy "git") ($createSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: kubero-pull-secret
  namespace: {{ $name }}-{{ .name }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ $dockerconfigjson | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-credentials
  namespace: {{ $name }}-{{ .name }}
  annotations:
    app.kubernetes.io/comment: "required by trivy to scan the image"
type: Opaque
data:
  username: {{ $registryUsername | quote }}
  password: {{ $registryPassword | quote }}
---
{{- end }}
{{- end }}
{{- end }}